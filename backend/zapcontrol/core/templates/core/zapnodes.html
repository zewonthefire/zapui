{% extends "core/base.html" %}

{% block title %}ZAP Nodes | ZapControl{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h3 mb-0">ZAP Nodes</h1>
    <div class="text-muted small mt-1">
      Internal instances: <strong>{{ registered_internal_count }}</strong> registered / <strong>{{ running_internal_count }}</strong> running containers
      {% if sync_result %}
        <span class="ms-2">(sync: +{{ sync_result.created }} created, {{ sync_result.disabled }} disabled)</span>
      {% endif %}
    </div>
  </div>
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="test_all_nodes">
    <input type="password" name="password" class="form-control form-control-sm d-inline-block w-auto" placeholder="Confirm password" required>
    <button class="btn btn-outline-primary">Test all nodes</button>
  </form>
</div>

<div class="card mb-4">
  <div class="card-header">Add external node</div>
  <div class="card-body">
    <form method="post" class="row g-2">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_external">
      <div class="col-md-3"><input class="form-control" name="name" placeholder="Name" required></div>
      <div class="col-md-5"><input class="form-control" name="base_url" placeholder="http://zap-node:8090" required></div>
      <div class="col-md-3"><input class="form-control" name="api_key" placeholder="API key (optional)"></div>
      <div class="col-md-2"><input type="password" class="form-control" name="password" placeholder="Confirm password" required></div>
      <div class="col-md-1"><button class="btn btn-primary w-100">Add</button></div>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header">Registered nodes</div>
  <div class="table-responsive">
    <table class="table mb-0">
      <thead><tr><th>Name</th><th>Base URL</th><th>API key</th><th>Type</th><th>Status</th><th>Latency</th><th>Last check</th><th>Actions</th></tr></thead>
      <tbody>
      {% for node in nodes %}
        <tr>
          <td>{{ node.name }}</td>
          <td>{{ node.base_url }}</td>
          <td>{% if node.api_key %}<code>{{ node.api_key }}</code>{% else %}<span class="text-muted">-</span>{% endif %}</td>
          <td>{{ node.managed_type }}</td>
          <td>{{ node.status }}</td>
          <td>{% if node.last_latency_ms %}{{ node.last_latency_ms }} ms{% else %}-{% endif %}</td>
          <td>{% if node.last_health_check %}{{ node.last_health_check }}{% else %}-{% endif %}</td>
          <td class="d-flex gap-1">
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="action" value="test_node">
              <input type="hidden" name="node_id" value="{{ node.id }}">
              <input type="password" name="password" class="form-control form-control-sm" placeholder="Password" required>
              <button class="btn btn-sm btn-outline-primary">Test</button>
            </form>
            {% if node.managed_type == 'external' %}
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="action" value="remove_external">
              <input type="hidden" name="node_id" value="{{ node.id }}">
              <input type="password" name="password" class="form-control form-control-sm" placeholder="Password" required>
              <button class="btn btn-sm btn-outline-danger">Remove</button>
            </form>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="8" class="text-muted">No nodes configured.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
